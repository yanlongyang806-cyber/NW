name: Build GameServer

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Run code generation
        shell: cmd
        run: |
          echo ========================================
          echo Step: Run code generation
          echo ========================================
          echo Code generation skipped - not required for build
          echo [SUCCESS] Code generation step completed
        continue-on-error: true

      - name: Fix XML format issues
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Step: Fix XML format issues"
          Write-Host "========================================"
          try {
            Write-Host "Fixing XML format issues in .vcxproj files..."
            $files = Get-ChildItem -Path src -Recurse -Filter *.vcxproj -ErrorAction SilentlyContinue | Select-Object -First 20
            $fixedCount = 0
            foreach ($file in $files) {
              try {
                $content = Get-Content $file.FullName -Raw -ErrorAction Stop
                $fixed = $content -replace '(?s)(<PreBuildEvent>\s*<Command>)(.*?)(</Command>\s*</PreBuildEvent>)', {
                  $pre = $matches[1]
                  $cmd = ($matches[2] -replace '\s+', ' ' -replace ' & ', ' &amp; ' -replace '&(?!amp;)', '&amp;').Trim()
                  $post = $matches[3]
                  "$pre$cmd$post"
                }
                if ($fixed -ne $content) {
                  Set-Content -Path $file.FullName -Value $fixed -NoNewline -ErrorAction Stop
                  Write-Host "Fixed: $($file.Name)"
                  $fixedCount++
                }
              } catch {
                Write-Host "Warning: Could not process $($file.FullName): $_"
              }
            }
            Write-Host "Fixed $fixedCount project files"
            Write-Host "[SUCCESS] XML format fix step completed"
          } catch {
            Write-Host "[ERROR] XML format fix failed: $_"
            exit 1
          }

      - name: Create placeholder autogen files
        shell: cmd
        run: |
          echo ========================================
          echo Creating placeholder autogen files...
          echo ========================================
          if not exist src\Core\Common\AutoGen mkdir src\Core\Common\AutoGen
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\ChatServer_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\HeadshotServer_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\TestServer_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\ObjectDB_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\Controller_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder file > src\Core\Common\AutoGen\TextureServer_autogen_RemoteFuncs.c
          echo // autogeneratednocheckin - Placeholder header file > src\Core\Common\AutoGen\Controller_autogen_remotefuncs.h
          echo // autogeneratednocheckin - Placeholder header file > src\Core\Common\AutoGen\controller_autogen_remotefuncs.h
          echo [OK] Placeholder autogen files created
          echo Note: These files will be regenerated by structparser during PreBuildEvent
        continue-on-error: true

      - name: List project structure
        shell: cmd
        run: |
          echo ========================================
          echo Checking project structure...
          echo ========================================
          echo Current directory: %CD%
          echo.
          if exist src\Night\GameServer\NNOGameServer.sln (
            echo [OK] Solution file exists: src\Night\GameServer\NNOGameServer.sln
            dir src\Night\GameServer\*.sln /b
          ) else (
            echo [ERROR] Solution file not found!
            echo Searching for .sln files...
            dir /s /b *.sln 2>nul | findstr /i "GameServer"
            echo.
            echo Listing src\Night\GameServer\ directory:
            if exist src\Night\GameServer\ (
              dir src\Night\GameServer\ /b
            ) else (
              echo Directory src\Night\GameServer\ does not exist!
            )
            exit /b 1
          )
          echo.
          echo Checking for autogen files...
          if exist src\Core\Common\AutoGen\ChatServer_autogen_RemoteFuncs.c (
            echo [OK] ChatServer_autogen_RemoteFuncs.c exists
          ) else (
            echo [WARNING] ChatServer_autogen_RemoteFuncs.c not found
          )
          if exist src\Core\Common\AutoGen\ObjectDB_autogen_RemoteFuncs.c (
            echo [OK] ObjectDB_autogen_RemoteFuncs.c exists
          ) else (
            echo [WARNING] ObjectDB_autogen_RemoteFuncs.c not found
          )
          echo.
          echo [OK] Project structure check passed

      - name: Build NNOGameServer (Debug Configuration)
        shell: cmd
        run: |
          echo ========================================
          echo Building NNOGameServer...
          echo ========================================
          echo Solution: src/Night/GameServer/NNOGameServer.sln
          echo Configuration: Debug
          echo Platform: Win32
          echo PlatformToolset: v143
          echo.
          msbuild src/Night/GameServer/NNOGameServer.sln /p:Configuration=Debug /p:Platform=Win32 /p:PlatformToolset=v143 /p:UseMultiToolTask=true /p:EnforceProcessCountAcrossBuilds=true /m /v:normal /p:WarningLevel=0 /p:TreatWarningsAsErrors=false /p:RunCodeAnalysis=false /fl /flp:logfile=build.log;verbosity=normal
          set BUILD_EXIT_CODE=%ERRORLEVEL%
          echo.
          echo ========================================
          echo Build completed with exit code: %BUILD_EXIT_CODE%
          echo ========================================
          if %BUILD_EXIT_CODE% neq 0 (
            echo.
            echo [ERROR] Build failed!
            echo.
            echo Showing last 100 lines of build log:
            echo ----------------------------------------
            if exist build.log (
              powershell -Command "Get-Content build.log -Tail 100"
            ) else (
              echo Build log file not found!
            )
            echo ----------------------------------------
            echo.
            echo Showing error summary:
            if exist build.log (
              powershell -Command "Select-String -Path build.log -Pattern 'error|Error|ERROR' | Select-Object -Last 20"
            )
            exit /b %BUILD_EXIT_CODE%
          ) else (
            echo [SUCCESS] Build completed successfully!
            if exist src\Night\GameServer\Debug\GameServer.exe (
              echo [OK] Output file exists: src\Night\GameServer\Debug\GameServer.exe
              dir src\Night\GameServer\Debug\GameServer.exe
            ) else (
              echo [WARNING] Output file not found: src\Night\GameServer\Debug\GameServer.exe
              echo Listing Debug directory:
              if exist src\Night\GameServer\Debug\ (
                dir src\Night\GameServer\Debug\ /b
              )
            )
          )
        continue-on-error: false

      - name: Upload GameServer.exe
        uses: actions/upload-artifact@v4
        with:
          name: GameServer-Debug
          path: src/Night/GameServer/Debug/GameServer.exe
