name: Build GameServer

# 触发条件
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      # ==================== 代码生成步骤 ====================
      # 这是解决 C1083 文件缺失错误的关键
      - name: Run Code Generation Script
        run: |
          echo "Running code generation..."
          # !!! 请务必将下面的路径替换成你真实的生成脚本路径 !!!
          # 例如，如果脚本在项目根目录下，就写成: call generate.bat
          # 如果脚本在 tools 文件夹下，就写成: call tools/generate.bat
          call tools/generate_code.bat
        # 如果脚本执行失败（返回非0值），就让这个步骤失败
        continue-on-error: false

      # ==================== 编译步骤 ====================
      - name: Build the GameServer
        run: |
          echo "Starting build..."
          msbuild src/Night/GameServer/NNOGameServer.sln ^
            /p:Configuration=Debug ^
            /p:Platform=Win32 ^
            /p:PlatformToolset=v143 ^
            /m /v:minimal ^
            /p:RunCodeAnalysis=false
        continue-on-error: false

      # ==================== 上传步骤 ====================
      - name: Upload GameServer.exe
        uses: actions/upload-artifact@v4
        with:
          name: GameServer-Debug
          path: src/Night/GameServer/Debug/GameServer.exe
