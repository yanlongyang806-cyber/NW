'use strict';

var g_config = require('cryptic/configure')();
var ip = require('ip');

function isInternalIp(addrIn)
{
	var result = false;
	if(g_config.ipsTrusted)
	{
		g_config.ipsTrusted = [].concat(g_config.ipsTrusted);
		for(var i = 0; !result && i < g_config.ipsTrusted.length; i++)
		{
			result = inRange(addrIn, g_config.ipsTrusted[i]);
		}
	}

	return result || ip.isPrivate(addrIn);
}

function inRange(addrIn, addrRange)
{
	var a = addrRange.split('/');
	if(a.length > 1)
	{
		if(a[1].length < 3)
		{
			a[1] = masks[parseInt(a[1], 10)];
		}

		addrIn = ip.mask(addrIn, a[1]);
	}
	return ip.isEqual(addrIn, a[0]);
}

var masks = [
	'0.0.0.0',
	'128.0.0.0',
	'192.0.0.0',
	'224.0.0.0',
	'240.0.0.0',
	'248.0.0.0',
	'252.0.0.0',
	'254.0.0.0',
	'255.0.0.0',

	'255.128.0.0',
	'255.192.0.0',
	'255.224.0.0',
	'255.240.0.0',
	'255.248.0.0',
	'255.252.0.0',
	'255.254.0.0',
	'255.255.0.0',

	'255.255.128.0',
	'255.255.192.0',
	'255.255.224.0',
	'255.255.240.0',
	'255.255.248.0',
	'255.255.252.0',
	'255.255.254.0',
	'255.255.255.0',

	'255.255.255.128',
	'255.255.255.192',
	'255.255.255.224',
	'255.255.255.240',
	'255.255.255.248',
	'255.255.255.252',
	'255.255.255.254',
	'255.255.255.255'
];

module.exports = isInternalIp;

// End of File
